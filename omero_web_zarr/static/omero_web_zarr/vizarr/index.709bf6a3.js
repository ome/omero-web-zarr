var t=Object.defineProperty,r=Object.defineProperties,e=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(r,e,n)=>e in r?t(r,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[e]=n,a=(t,r)=>{for(var e in r||(r={}))o.call(r,e)&&i(t,e,r[e]);if(n)for(var e of n(r))s.call(r,e)&&i(t,e,r[e]);return t},c=(t,n)=>r(t,e(n));function f(t,r=/{{(.*?)}}/){let e=r.exec(t);const n=[];let o;for(;e;)o=e.index,0!==o&&(n.push({match:!1,str:t.substring(0,o)}),t=t.slice(o)),n.push({match:!0,str:e[0]}),t=t.slice(e[0].length),e=r.exec(t);return t&&n.push({match:!1,str:t}),n}const u="abcdefghijklmnopqrstuvwxyz",l=new Set(u+u.toUpperCase()+"01234569789()*/+- ");function h(t,r){return f(t).map((t=>{if(!t.match)return t.str;let e=t.str.split(/{{|}}/).filter(Boolean)[0].trim();if(e in r)return r[e];const n=function(t){const r=t.match(/(?<fname>[A-Z_][A-Z_1-9]*)\((?<args>[^)]+)\)/i);if(!(null==r?void 0:r.groups))return;const{fname:e,args:n}=r.groups;return{fname:e,ctx:Object.fromEntries(n.split(",").map((t=>{var r,e;const{key:n,num:o,str:s}=null!=(e=null==(r=t.match(/(?<key>[a-z_0-9]*)\s*=\s*((?<num>[0-9.]+)|('|")(?<str>.*)('|"))/i))?void 0:r.groups)?e:{};if(!n||!o&&!s)throw Error(`Failed to match fn kwarg: ${t}`);return[n,o?Number(o):s]})))}}(e);if(n){const{fname:t,ctx:e}=n,o=r[t];if("function"==typeof o)return o(e);throw Error(`Cannot find function named ${t} in rendering context.`)}const o=function(t){for(let r=0;r<t.length;r++)if(!l.has(t.charAt(r)))return;return f(t,/[A-Za-z_][A-Za-z0-9_]*/gi)}(e);if(o){const t=o.map((t=>{if(!t.match)return t.str;const e=r[t.str];if(null==e)throw Error(`Cannot find number named ${t.str} in rendering context.`);if("number"!=typeof e)throw Error(`The provided value for ${t.str} must be a number.`);return e}));return Function('"use strict";return ('+t.join("")+")")()}throw new Error(`Unable to match ${t.str}`)})).join("")}function p(t,r=h){return"version"in t?function(t,r){var e;const n={};for(const[i,a]of Object.entries(t.templates))a.includes("{{")?n[i]=t=>r(a,t):n[i]=a;const o=(t,e)=>r(t,a(a({},n),e)),s=new Map;for(const[i,a]of Object.entries(t.refs))if("string"==typeof a)s.set(i,a);else{const t=(null==(e=a[0])?void 0:e.includes("{{"))?o(a[0]):a[0];s.set(i,1===a.length?[t]:[t,a[1],a[2]])}for(const i of t.gen)for(const t of m(i.dimensions)){const r=o(i.key,t),e=o(i.url,t),n=o(i.offset,t),a=o(i.length,t);s.set(r,[e,parseInt(n),parseInt(a)])}return s}(t,r):function(t){return new Map(Object.entries(t))}(t)}function*m(t){const r=Object.keys(t),e=Object.values(t).map((t=>Array.isArray(t)?t:[...d(t)]));for(const n of function*(...t){if(0===t.length)return;const r=t.map((t=>t[Symbol.iterator]())),e=r.map((t=>t.next()));if(e.some((t=>t.done)))throw new Error("Input contains an empty iterator.");for(let n=0;;){if(e[n].done){if(r[n]=t[n][Symbol.iterator](),e[n]=r[n].next(),++n>=r.length)return}else yield e.map((({value:t})=>t)),n=0;e[n]=r[n].next()}}(...e))yield Object.fromEntries(r.map(((t,r)=>[t,n[r]])))}function*d({stop:t,start:r=0,step:e=1}){for(let n=r;n<t;n+=e)yield n}class y extends Error{constructor(t){var r;super(t),i(this,"symbol"!=typeof(r="__zarr__")?r+"":r,"KeyError"),this.name="KeyError"}}class g{constructor(t,r={}){this.ref=t,this.target=r.target}static fromJSON(t,r={}){const e=p("string"==typeof t?JSON.parse(t):t,r.renderString);return new g(e,r)}_url(t){const[r,e]=t.split("://");if("https"===r||"http"===r)return t;throw Error("Protocol not supported, got: "+JSON.stringify(r))}_fetch({url:t,offset:r,size:e},n){return void 0!==r&&void 0!==e&&(n=c(a({},n),{headers:c(a({},n.headers),{Range:`bytes=${r}-${r+e-1}`})})),fetch(this._url(t),n)}async getItem(t,r={}){const e=this.ref.get(t);if(!e)throw new y(t);if("string"==typeof e)return e.startsWith("base64:")?b(e.slice(7)).buffer:w.encode(e).buffer;const[n,o,s]=e,i=null!=n?n:this.target;if(!i)throw Error(`No url for key ${t}, and no target url provided.`);const a=await this._fetch({url:i,offset:o,size:s},r);if(200===a.status||206===a.status)return a.arrayBuffer();throw new Error(`Request unsuccessful for key ${t}. Response status: ${a.status}.`)}async containsItem(t){return this.ref.has(t)}async keys(){return[...this.ref.keys()]}setItem(t,r){throw Error("FileReferenceStore.setItem is not implemented.")}deleteItem(t){throw Error("FileReferenceStore.deleteItem is not implemented.")}}const b=(()=>{for(var t=new Uint8Array(128),r=0;r<64;r++)t[r<26?r+65:r<52?r+71:r<62?r-4:4*r-205]=r;return r=>{for(var e=r.length,n=new Uint8Array(3*(e-("="==r[e-1])-("="==r[e-2]))/4|0),o=0,s=0;o<e;){var i=t[r.charCodeAt(o++)],a=t[r.charCodeAt(o++)],c=t[r.charCodeAt(o++)],f=t[r.charCodeAt(o++)];n[s++]=i<<2|a>>4,n[s++]=a<<4|c>>2,n[s++]=c<<6|f}return n}})(),w=new TextEncoder;export{g as ReferenceStore,p as parse};
